<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <title>–ê—Ä—Ç –ì–∞–ª–µ—Ä–∏—è</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header>
        <nav>
            <ul class="nav-menu">
                <li><a href="/">–ù–∞—á–∞–ª–æ</a></li> 
                
                <li class="dropdown">
                    <a href="#">–ü–ª–∞–∫–∞—Ç–∏ ‚ñº</a>
                    <ul class="submenu">
                        <li><a href="#" onclick="filterArt('–ü–ª–∞–∫–∞—Ç–∏', 8)">8 –∫–ª–∞—Å</a></li>
                        <li><a href="#" onclick="filterArt('–ü–ª–∞–∫–∞—Ç–∏', 9)">9 –∫–ª–∞—Å</a></li>
                        <li><a href="#" onclick="filterArt('–ü–ª–∞–∫–∞—Ç–∏', 10)">10 –∫–ª–∞—Å</a></li>
                        <li><a href="#" onclick="filterArt('–ü–ª–∞–∫–∞—Ç–∏', 11)">11 –∫–ª–∞—Å</a></li>
                        <li><a href="#" onclick="filterArt('–ü–ª–∞–∫–∞—Ç–∏', 12)">12 –∫–ª–∞—Å</a></li>
                    </ul>
                </li>
                
                <li class="dropdown">
                    <a href="#">–ì—Ä–∞—Ñ–∏–∫–∞ ‚ñº</a>
                    <ul class="submenu">
                        <li><a href="#" onclick="filterArt('–ì—Ä–∞—Ñ–∏–∫–∞', 8)">8 –∫–ª–∞—Å</a></li>
                        <li><a href="#" onclick="filterArt('–ì—Ä–∞—Ñ–∏–∫–∞', 9)">9 –∫–ª–∞—Å</a></li>
                        <li><a href="#" onclick="filterArt('–ì—Ä–∞—Ñ–∏–∫–∞', 10)">10 –∫–ª–∞—Å</a></li>
                        <li><a href="#" onclick="filterArt('–ì—Ä–∞—Ñ–∏–∫–∞', 11)">11 –∫–ª–∞—Å</a></li>
                        <li><a href="#" onclick="filterArt('–ì—Ä–∞—Ñ–∏–∫–∞', 12)">12 –∫–ª–∞—Å</a></li>
                    </ul>
                </li>

                <li><a href="#" onclick="filterByCategory('–î–∏–ø–ª–æ–º–Ω–∞ —Ä–∞–±–æ—Ç–∞')">–ü—Ä–æ–µ–∫—Ç–∏</a></li>
                <li><a href="studio.html">–ê—Ä—Ç –°—Ç—É–¥–∏–æ</a></li>
                <li><a href="about.html">–ó–∞ –Ω–∞—Å</a></li>
                
                <li><a href="#" onclick="logout()" style="color: #ff4d4d; margin-left: 20px;">–ò–∑—Ö–æ–¥</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section id="top-artworks-section" style="margin: 20px; background: #fffcf0; padding: 20px; border-radius: 15px; display: none;">
            <h2 style="text-align: center; color: #f1c40f;">üèÜ –¢–æ–ø 3 –ù–∞–π-—Ö–∞—Ä–µ—Å–≤–∞–Ω–∏</h2>
            <div id="top-gallery" class="gallery-container"></div>
            <hr style="width: 80%; margin: 40px auto; border: 0.5px solid #eee;">
        </section>

        <h1 id="gallery-title" style="text-align: center; margin-top: 30px;">–ì–∞–ª–µ—Ä–∏—è –Ω–∞ —Ç–∞–ª–∞–Ω—Ç–∏—Ç–µ</h1>
        <div id="gallery" class="gallery-container"></div>
    </main>

    <script>
        // 1. –ü–†–û–í–ï–†–ö–ê –ó–ê –õ–û–ì–ò–ù
        if (!localStorage.getItem('galleryUser')) {
            window.location.href = 'login.html';
        }

        // 2. –§–£–ù–ö–¶–ò–Ø –ó–ê –ò–ó–•–û–î
        function logout() {
            localStorage.removeItem('galleryUser');
            window.location.href = 'login.html';
        }

        // 3. –°–™–ó–î–ê–í–ê–ù–ï –ù–ê –ö–ê–†–¢–ê
        function createCard(art) {
            return `
                <div class="artwork-card">
                    <img src="${art.imageUrl}" alt="–ö–∞—Ä—Ç–∏–Ω–∞">
                    <div class="overlay">
                        <div class="student-name">${art.studentName}</div>
                        <div class="stars" onclick="vote(${art.id})" style="cursor:pointer">
                            ‚≠ê <span id="rating-${art.id}">${art.averageRating || 0}</span>
                        </div>
                        <div style="font-size: 0.8rem; margin-top:10px;">${art.category}, ${art.grade} –∫–ª–∞—Å</div>
                    </div>
                </div>
            `;
        }

        // 4. –ì–õ–ê–°–£–í–ê–ù–ï
        function vote(id) {
    const userEmail = localStorage.getItem('userEmail'); // –í–∑–∏–º–∞–º–µ –∏–º–µ–π–ª–∞
    if (!userEmail) {
        alert("–ì—Ä–µ—à–∫–∞: –ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω –∏–º–µ–π–ª. –ú–æ–ª—è, –∏–∑–ª–µ–∑—Ç–µ –∏ –≤–ª–µ–∑—Ç–µ –æ—Ç–Ω–æ–≤–æ.");
        return;
    }

    const rating = prompt("–û—Ü–µ–Ω–∏ –æ—Ç 1 –¥–æ 5:");
    if (rating >= 1 && rating <= 5) {
        fetch('/api/vote', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                id: id, 
                rating: rating, 
                email: userEmail // –ü–†–ê–©–ê–ú–ï –ò–ú–ï–ô–õ–ê –ö–™–ú –°–™–†–í–™–†–ê
            })
        }).then(async res => {
            const data = await res.json();
            if (res.ok) {
                alert("–ë–ª–∞–≥–æ–¥–∞—Ä–∏–º –∑–∞ –≥–ª–∞—Å–∞!");
                location.reload();
            } else {
                alert(data.message); // –¢—É–∫ —â–µ –∫–∞–∂–µ "–í–µ—á–µ —Å—Ç–µ –≥–ª–∞—Å—É–≤–∞–ª–∏"
            }
        });
    }
}

        // 5. –§–ò–õ–¢–†–ò–†–ê–ù–ï
        function filterArt(category, grade) {
            fetch('/api/artworks').then(res => res.json()).then(data => {
                const gallery = document.getElementById('gallery');
                gallery.innerHTML = "";
                const filtered = data.filter(a => a.category === category && a.grade == grade);
                filtered.length ? filtered.forEach(a => gallery.innerHTML += createCard(a)) 
                               : gallery.innerHTML = "<p style='text-align:center; width:100%;'>–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ —Ç–≤–æ—Ä–±–∏.</p>";
                document.getElementById('top-artworks-section').style.display = 'none';
                document.getElementById('gallery-title').innerText = `${category} - ${grade} –∫–ª–∞—Å`;
            });
        }

        function filterByCategory(cat) {
            fetch('/api/artworks').then(res => res.json()).then(data => {
                const gallery = document.getElementById('gallery');
                gallery.innerHTML = "";
                const filtered = data.filter(a => a.category === cat);
                if (filtered.length > 0) {
                    filtered.forEach(a => gallery.innerHTML += createCard(a));
                } else {
                    gallery.innerHTML = `<p style='text-align:center; width:100%;'>–í—Å–µ –æ—â–µ –Ω—è–º–∞ –ø—Ä–æ–µ–∫—Ç–∏ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—è "${cat}".</p>`;
                }
                document.getElementById('top-artworks-section').style.display = 'none';
                document.getElementById('gallery-title').innerText = cat;
            });
        }

        // 6. –ó–ê–†–ï–ñ–î–ê–ù–ï –ü–†–ò –°–¢–ê–†–¢
        fetch('/api/artworks').then(res => res.json()).then(artworks => {
            const gallery = document.getElementById('gallery');
            const topGallery = document.getElementById('top-gallery');
            
            if (artworks.length > 0) {
                document.getElementById('top-artworks-section').style.display = 'block';
                
                // –¢–æ–ø 3
                const top3 = [...artworks].sort((a,b) => (b.averageRating || 0) - (a.averageRating || 0)).slice(0,3);
                top3.forEach(a => topGallery.innerHTML += createCard(a));
                
                // –í—Å–∏—á–∫–∏
                artworks.forEach(a => gallery.innerHTML += createCard(a));
            } else {
                gallery.innerHTML = "<p style='text-align:center; width:100%;'>–ù—è–º–∞ –∫–∞—á–µ–Ω–∏ —Ç–≤–æ—Ä–±–∏.</p>";
            }
        });
    </script>
</body>
</html>